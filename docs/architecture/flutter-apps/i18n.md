# Multi-language Support (i18n)

## Overview

### What This Feature Solves
Multi-language support enables the Altea mobile application to display UI text in the user's preferred language. It implements the standard Flutter localization approach with ARB files and supports per-app language settings on iOS 13+ and Android 13+.

### Use Cases
1. **UC1: Automatic Language Selection** - App uses device system language on first launch
2. **UC2: Per-App Language (iOS)** - User changes language via Settings → Altea → Language
3. **UC3: Per-App Language (Android 13+)** - User changes language via Settings → Apps → Altea → Language
4. **UC4: Fallback for Unsupported Languages** - App displays English when system language is not supported

### Supported Languages
| Code | Language | Region |
|------|----------|--------|
| `en` | English | Fallback/Default |
| `de` | German | German-speaking Switzerland |
| `fr` | French | French-speaking Switzerland |
| `it` | Italian | Italian-speaking Switzerland |

## Architecture

### Components

#### Flutter Packages
| Package | Version | Purpose |
|---------|---------|---------|
| `flutter_localizations` | SDK | Material/Cupertino localization delegates |
| `intl` | ^0.20.2 | Internationalization utilities |

#### Key Files

| File | Purpose |
|------|---------|
| `l10n.yaml` | Code generation configuration |
| `lib/l10n/app_en.arb` | English translations (template) |
| `lib/l10n/app_de.arb` | German translations |
| `lib/l10n/app_fr.arb` | French translations |
| `lib/l10n/app_it.arb` | Italian translations |
| `lib/l10n/app_localizations.dart` | Generated localization class |
| `lib/core/extensions/build_context_extensions.dart` | Context extension for easy access |

#### Platform Configuration

| Platform | File | Purpose |
|----------|------|---------|
| iOS | `ios/Runner/Info.plist` | `CFBundleLocalizations` array |
| Android | `android/app/src/main/res/xml/locales_config.xml` | Per-app language config |
| Android | `android/app/src/main/AndroidManifest.xml` | `localeConfig` reference |

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        MaterialApp.router                           │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ localizationsDelegates:                                       │  │
│  │   - AppLocalizations.delegate                                 │  │
│  │   - GlobalMaterialLocalizations.delegate                      │  │
│  │   - GlobalWidgetsLocalizations.delegate                       │  │
│  │   - GlobalCupertinoLocalizations.delegate                     │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ supportedLocales: [en, de, fr, it]                            │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      AppLocalizations                                │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ Generated from ARB files via flutter gen-l10n                 │  │
│  │                                                               │  │
│  │ AppLocalizations.of(context)!.signIn                          │  │
│  │ context.l10n.signIn  (via extension)                          │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
              ┌──────────┐   ┌──────────┐   ┌──────────┐
              │ app_en   │   │ app_de   │   │ app_fr   │ ...
              │   .arb   │   │   .arb   │   │   .arb   │
              └──────────┘   └──────────┘   └──────────┘
```

## Implementation Details

### Code Generation Configuration

`l10n.yaml`:
```yaml
arb-dir: lib/l10n
template-arb-file: app_en.arb
output-localization-file: app_localizations.dart
output-class: AppLocalizations
output-dir: lib/l10n
```

### MaterialApp Configuration

`lib/main.dart:22-37`:
```dart
MaterialApp.router(
  localizationsDelegates: const [
    AppLocalizations.delegate,
    GlobalMaterialLocalizations.delegate,
    GlobalWidgetsLocalizations.delegate,
    GlobalCupertinoLocalizations.delegate,
  ],
  supportedLocales: const [
    Locale('en'), // English (fallback)
    Locale('de'), // German
    Locale('fr'), // French
    Locale('it'), // Italian
  ],
  // ...
)
```

### Context Extension

`lib/core/extensions/build_context_extensions.dart`:
```dart
extension BuildContextExtensions on BuildContext {
  AppLocalizations get l10n => AppLocalizations.of(this)!;
}
```

### Using Localized Strings

```dart
import 'package:altea_mobile/core/extensions/build_context_extensions.dart';

// In widget build method:
Text(context.l10n.signIn)
Text(context.l10n.fieldRequired('Email'))  // With placeholder
Text(context.l10n.fieldMinLength('Password', 8))  // Multiple placeholders
```

### ARB File Structure

`app_en.arb` (template):
```json
{
  "@@locale": "en",

  "signIn": "Sign In",
  "@signIn": {"description": "Sign in button and title"},

  "fieldRequired": "{field} is required",
  "@fieldRequired": {
    "description": "Generic required field error",
    "placeholders": {
      "field": {"type": "String"}
    }
  }
}
```

### Platform Configuration

#### iOS - Info.plist

```xml
<key>CFBundleLocalizations</key>
<array>
    <string>en</string>
    <string>de</string>
    <string>fr</string>
    <string>it</string>
</array>
```

#### Android - locales_config.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<locale-config xmlns:android="http://schemas.android.com/apk/res/android">
    <locale android:name="en"/>
    <locale android:name="de"/>
    <locale android:name="fr"/>
    <locale android:name="it"/>
</locale-config>
```

#### Android - AndroidManifest.xml

```xml
<application
    android:localeConfig="@xml/locales_config"
    ...>
```

## Translation Keys

### Categories

| Category | Keys | Screens |
|----------|------|---------|
| Login | 14 | `login_screen.dart` |
| Registration | 20 | `registration_screen.dart` |
| Email Sent | 8 | `email_sent_screen.dart` |
| Legal | 6 | `terms_screen.dart`, `privacy_screen.dart` |
| **Total** | **48** | |

### Parameterized Strings

| Key | Parameters | Example |
|-----|------------|---------|
| `fieldRequired` | `{field}` | "Email is required" |
| `fieldMinLength` | `{field}`, `{count}` | "Password must be at least 8 characters" |
| `couldNotOpen` | `{title}` | "Could not open Terms of Service" |
| `failedToOpen` | `{title}`, `{error}` | "Failed to open Privacy Policy: Network error" |

## Testing

### Running Tests

```bash
cd mobile

# All localization tests
flutter test test/l10n/

# Specific test files
flutter test test/l10n/arb_validation_test.dart
flutter test test/l10n/app_localizations_test.dart
flutter test test/l10n/locale_switching_test.dart

# Screen localization tests
flutter test test/presentation/screens/auth/login_screen_l10n_test.dart
flutter test test/presentation/screens/auth/registration_screen_l10n_test.dart
flutter test test/presentation/screens/auth/email_sent_screen_l10n_test.dart
```

### Test Coverage

| Test File | Tests | Coverage |
|-----------|-------|----------|
| `arb_validation_test.dart` | 13 | ARB structure, key consistency, placeholders |
| `app_localizations_test.dart` | 18 | Delegate, locales, translations |
| `locale_switching_test.dart` | 9 | Language switching, fallback, regions |
| `login_screen_l10n_test.dart` | 10 | EN/DE/FR/IT displays, validation |
| `registration_screen_l10n_test.dart` | 12 | EN/DE/FR/IT displays, validation, terms |
| `email_sent_screen_l10n_test.dart` | 9 | EN/DE/FR/IT displays, resend, navigation |
| **Total** | **71** | |

### Test Helpers

`test/helpers/l10n_test_helpers.dart` provides utilities for localized widget testing.

## Development Commands

```bash
cd mobile

# Generate localization files
flutter gen-l10n

# Verify no issues
flutter analyze

# Run app
flutter run
```

## Adding New Strings

### Step 1: Add to English ARB (template)

`lib/l10n/app_en.arb`:
```json
{
  "newKey": "New text in English",
  "@newKey": {"description": "Description for translators"}
}
```

### Step 2: Add to Other Languages

Add the same key to `app_de.arb`, `app_fr.arb`, `app_it.arb`.

### Step 3: Regenerate

```bash
flutter gen-l10n
```

### Step 4: Use in Code

```dart
Text(context.l10n.newKey)
```

## Language Fallback

```
User's Device Language
         │
         ▼
  ┌──────────────┐
  │ Is supported │
  │ (en/de/fr/it)│
  └──────┬───────┘
         │
    ┌────┴────┐
    │Yes      │No
    ▼         ▼
┌────────┐ ┌────────┐
│ Use    │ │ Use    │
│ device │ │ English│
│ locale │ │(fallback)│
└────────┘ └────────┘
```

Regional variants (e.g., `de_CH`, `fr_CH`) automatically resolve to base language.

## File Structure

```
mobile/
├── l10n.yaml                           # Code generation config
├── lib/
│   ├── l10n/
│   │   ├── app_en.arb                  # English (template)
│   │   ├── app_de.arb                  # German
│   │   ├── app_fr.arb                  # French
│   │   ├── app_it.arb                  # Italian
│   │   ├── app_localizations.dart      # Generated
│   │   ├── app_localizations_en.dart   # Generated
│   │   ├── app_localizations_de.dart   # Generated
│   │   ├── app_localizations_fr.dart   # Generated
│   │   └── app_localizations_it.dart   # Generated
│   ├── core/
│   │   └── extensions/
│   │       └── build_context_extensions.dart  # l10n shortcut
│   └── main.dart                       # Localization delegates
├── ios/
│   └── Runner/
│       └── Info.plist                  # CFBundleLocalizations
├── android/
│   └── app/
│       └── src/
│           └── main/
│               ├── AndroidManifest.xml # localeConfig reference
│               └── res/
│                   └── xml/
│                       └── locales_config.xml  # Per-app language
└── test/
    ├── l10n/
    │   ├── arb_validation_test.dart
    │   ├── app_localizations_test.dart
    │   └── locale_switching_test.dart
    ├── helpers/
    │   └── l10n_test_helpers.dart
    └── presentation/
        └── screens/
            └── auth/
                ├── login_screen_l10n_test.dart
                ├── registration_screen_l10n_test.dart
                └── email_sent_screen_l10n_test.dart
```

## Known Limitations

1. **No in-app language picker** - Uses system per-app settings (intentional design choice)
2. **Android < 13** - Falls back to system language only (no per-app settings)
3. **No RTL support** - Arabic, Hebrew not included (out of scope)
4. **No dynamic loading** - All translations bundled in app
5. **No backend translation** - API error messages are in English

## Related Documentation

- [Mobile App Architecture](./mobile-app.md)
- [User Registration Feature](../../features/user-registration/README.md)
- [User Login Feature](../../features/user-login/README.md)
